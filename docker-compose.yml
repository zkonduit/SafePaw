version: '3.8'

services:
  # SafeClaw API server
  safeclaw:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: safeclaw-api
    ports:
      - "12345:12345"
    environment:
      # Server configuration
      PORT: 12345
      HOST: 0.0.0.0
      NODE_ENV: production

      # Ethereum configuration
      START_ANVIL: "false"  # Anvil runs on host machine
      ETHEREUM_RPC_URL: http://host.docker.internal:8545
      PRIVATE_KEY: ${PRIVATE_KEY:-0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80}

      # Contract address (will be auto-set on first run)
      CONTRACT_ADDRESS: ${CONTRACT_ADDRESS:-}
    extra_hosts:
      - "host.docker.internal:host-gateway"
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://0.0.0.0:12345/status || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    volumes:
      # Mount .env file to persist contract address updates to host
      - ./.env:/app/.env
